var Code2Mind=function(){"use strict";var t;!function(t){t.SPACE=" ",t.TAB="\t",t.SPACE_TAB="  ",t.LINE="\n"}(t||(t={}));var e=function(t,e,i,n,o){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=0),void 0===n&&(n=null),void 0===o&&(o=[]),this.uid=t,this.title=e,this.children=o,this.parentUid=n,this.level=i},i=function(){function t(){}return t.getUUid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},t.download=function(t,e,i){if(navigator.msSaveOrOpenBlob)return navigator.msSaveOrOpenBlob(t,e),void(i&&i());var n=document.createElement("a");n.style.display="none",n["href-lang"]="image/svg+xml",n.download=e||(new Date).getTime()+".png",n.href=URL.createObjectURL(t),n.target="_blank",document.body.appendChild(n),n.click(),setTimeout((function(){document.body.removeChild(n),URL.revokeObjectURL(n.href),i&&i()}),100)},t}(),n=function(){function n(){}return n.parse=function(t){if(void 0===t&&(t=""),t){var o=t.replace(/\r\n/g,"\n").split("\n"),d=new e(i.getUUid());return o.forEach((function(t,e){0===e?d.title=t:n.parseLine(t,d)})),d}return null},n.parseLine=function(t,n){if(void 0===t&&(t=""),t){var o=this.getToken(t,0);if("END"!==o.type&&n.children.length){var d=n.children.length-1;this.parseLine(o.token,n.children[d])}else{var h=new e(i.getUUid(),o.token,n.level+1,n.uid);n.children.push(h)}}},n.getToken=function(e,i){void 0===i&&(i=0);var n=e.charAt(i);return n===t.TAB?{token:e.substring(i+1),type:"TAB"}:n===t.SPACE&&e.charAt(i+1)===t.SPACE?{token:e.substring(i+2),type:"SPACE"}:{token:e.trim(),type:"END"}},n}();!function(t,e){void 0===e&&(e={});var i=e.insertAt;if(t&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===i&&n.firstChild?n.insertBefore(o,n.firstChild):n.appendChild(o),o.styleSheet?o.styleSheet.cssText=t:o.appendChild(document.createTextNode(t))}}(".code2mind-main {\n  position: absolute;\n  padding: 10px 50px;\n  line-height: 22px;\n  min-height: 40px;\n  color: #FFFFFF;\n  border-radius: 50%;\n  white-space: nowrap;\n  text-align: left;\n  font-size: 14px;\n  background: #fa815e;\n  box-sizing: border-box;\n  margin: 0 0;\n}\n\n.code2mind-main-item {\n  border-radius: 4px;\n  padding: 10px 20px;\n}\n\n.code2mind-main-item2 {\n  background: transparent;\n  border-radius: 0;\n  color: #999999;\n  border-bottom: 2px solid #999999;\n}\n");var o=function(t,e){Object.keys(e).forEach((function(i){t.setAttribute(i,e[i])}))},d=function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg",t);return o(i,e),i},h=function(t){var e=document.createElement("div"),i="code2mind-main";return t.level>0&&(i+=" code2mind-main-item"),t.level>1&&(i+=" code2mind-main-item2"),e.className=i,e.innerText=t.title,e};return function(){function t(t){if(this.config=Object.assign({heightSpac:50,widthSpac:100,width:0,height:0,lineStyle:{curvature:80,stroke:"#DEDEDE",strokeWidth:2},themes:"default",el:"#code2mind"},t),this.el=document.querySelector(this.config.el),t.width||(this.config.width=this.el.offsetWidth),t.height||(this.config.height=this.el.offsetHeight),!this.el)throw this.config.el+"，对应的dom不存在";this.el.style.position="relative"}return t.prototype.html2svg=function(t,e,i,n,o){var h=d("svg",{width:t,height:e}),l=d("foreignObject",{width:"100%",height:"100%",x:i,y:n,externalResourcesRequired:!0});return l.appendChild(o),h.appendChild(l),h},t.prototype.setCssStyle=function(t,e){if(t.children&&t.children.length>0)for(var i=0,n=t.children.length;i<n;i++)this.setCssStyle(t.children.item(i),e);var o=getComputedStyle(t,null);t.style.cssText=o.cssText,t.className=""},t.prototype.svg2img=function(t){return new Promise((function(e,i){var n=new Image;n.onload=function(){return e(n)},n.onerror=i,n.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(t))}))},t.prototype.picture=function(t,e){var n=this;if(void 0===t&&(t=1),void 0===e&&(e=10),t<=0)throw"缩放比例必须是大于0";var d=document.getElementById("code2mindContent").cloneNode(!0);o(d,{style:"top:0;left:0;transform-origin:0 0;transform:scale("+t+")"});var h=this.result.bound.clientWidth*t+2*e,l=this.result.bound.clientHeight*t+2*e,c=this.html2svg(h,l,e,e,d),r=document.createElement("div");o(r,{style:"top:0;left:0;position:absolute;z-index:-555;width:0;height:0;overflow:hidden;"}),r.appendChild(c),document.body.appendChild(r),this.setCssStyle(d,t);var a=document.getElementById("code2mindSvg").cloneNode(!0);o(a,{width:h,height:l,style:"transform-origin:0 0;transform:scale("+t+")"});var u=document.createElement("canvas"),s=u.getContext("2d");u.width=h,u.height=l,this.svg2img(a).then((function(t){s.drawImage(t,e,e)})).then((function(){return n.svg2img(c)})).then((function(t){s.drawImage(t,0,0),u.toBlob((function(t){i.download(t,null,null)}))})).finally((function(){document.body.removeChild(r)}))},t.prototype.render=function(t){void 0===t&&(t=""),this.el.innerHTML="";var e=n.parse(t);if(this.result=e,e){var i=this.el.cloneNode(!0);o(i,{style:"z-index: -9000;visibility:hidden;"}),document.body.appendChild(i),this.calcBound(i,e),document.body.removeChild(i),this.layout(e,e.bound.leftWidht>0?e.bound.leftWidht+this.config.widthSpac:0,e.bound.height>=e.bound.clientHeight?0:e.bound.clientHeight/2,!1);var h=this.config.height/2-e.bound.clientHeight/2,l=this.config.width/2-e.bound.clientWidth/2,c=d("svg",{width:e.bound.clientWidth.toString(),height:e.bound.clientHeight.toString(),id:"code2mindSvg"}),r=document.createElement("div");o(r,{id:"code2mindContent",style:"top:"+h+"px;left:"+l+"px;position:relative;z-index:1;width:"+e.bound.clientWidth+"px;height:"+e.bound.clientHeight+"px;"}),this.drawMind(r,e,c),this.el.appendChild(r);var a=document.createElement("div");o(a,{style:"top:"+h+"px;left:"+l+"px;position:absolute;"}),a.appendChild(c),this.el.appendChild(a)}},t.prototype.drawMind=function(t,e,i){var n=this,o=h(e);if(o.style.top=e.top+"px",o.style.left=e.left+"px",e.children.length){var l=0===e.level?e.left+e.bound.width/2:e.isLeft?e.left:e.left+e.bound.width,c=(0===e.level||1===e.level?e.top+e.bound.height/2:e.top+e.bound.height)-1;e.children.forEach((function(e){var o=e.isLeft?l-n.config.lineStyle.curvature:l+n.config.lineStyle.curvature,h=e.isLeft?e.left+e.bound.width:e.left,r=(1===e.level?e.top+e.bound.height/2:e.top+e.bound.height)-1,a="M "+l+" "+c+" C "+o+" "+c+" "+(e.isLeft?h+n.config.lineStyle.curvature:h-n.config.lineStyle.curvature)+" "+r+" "+h+" "+r,u=d("path",{d:a,stroke:n.config.lineStyle.stroke,"stroke-width":n.config.lineStyle.strokeWidth,fill:"none"});i.append(u),n.drawMind(t,e,i)}))}t.appendChild(o)},t.prototype.layout=function(t,e,i,n){var o=this;if(t.children.length)if(0===t.level){var d=i+t.bound.height/2-t.bound.leftHeight/2,h=i+t.bound.height/2-t.bound.rightHeight/2;t.children.forEach((function(i,n){if(i.isLeft){var l=e-o.config.widthSpac-i.bound.width;d+=0===n?0:t.children[n-2].bound.clientHeight+o.config.heightSpac,o.layout(i,l,d-i.bound.height/2+i.bound.clientHeight/2,!0)}else if(i.isRight){l=e+o.config.widthSpac+t.bound.width;h+=n-1==0?0:t.children[n-2].bound.clientHeight+o.config.heightSpac,o.layout(i,l,h-i.bound.height/2+i.bound.clientHeight/2,!1)}}))}else{var l=e+this.config.widthSpac+t.bound.width;n&&(l=e-this.config.widthSpac);var c=i+t.bound.height/2-t.bound.clientHeight/2;1===t.level&&(c-=t.bound.height/2),t.children.forEach((function(e,i){c+=(0===i?0:t.children[i-1].bound.clientHeight)+(0===i?0:o.config.heightSpac),o.layout(e,n?l-e.bound.width:l,c-e.bound.height/2+e.bound.clientHeight/2,n)}))}n&&(t.isLeft=n),t.top=i,t.left=e},t.prototype.calcBound=function(t,e){var i=this,n={clientWidth:0,clientHeight:0,width:0,height:0,leftWidht:0,leftHeight:0,rightWidth:0,rightHeight:0},o=h(e);t.appendChild(o),n.clientWidth=n.width=o.offsetWidth,n.clientHeight=n.height=o.offsetHeight;var d=e.children.length;if(d){var l=0,c=0,r=0,a=0,u=0,s=0;e.children.forEach((function(n,o){i.calcBound(t,n),0===e.level?o%2==0?(n.isLeft=!0,r+=n.bound.clientHeight+i.config.heightSpac,n.bound.clientWidth>u&&(u=n.bound.clientWidth)):(n.isRight=!0,a+=n.bound.clientHeight+i.config.heightSpac,n.bound.clientWidth>s&&(s=n.bound.clientWidth)):(c+=n.bound.clientHeight,n.bound.clientWidth>l&&(l=n.bound.clientWidth))})),0===e.level?(r=(r-=this.config.heightSpac)>n.clientHeight?r:n.clientHeight,a=(a-=this.config.heightSpac)>n.clientHeight?a:n.clientHeight,n.leftHeight=r,n.rightHeight=a,n.leftWidht=u,n.rightWidth=s,n.clientHeight=Math.max(r,a),n.clientWidth=u+s+n.width+this.config.widthSpac*(0===u?0:0===s?1:2)):(c=(c+=(d-1)*this.config.heightSpac)>n.clientHeight?c:n.clientHeight,l+=n.clientWidth+this.config.widthSpac,n.clientWidth=l,n.clientHeight=c)}e.bound=n},t}()}();
